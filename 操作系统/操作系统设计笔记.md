## 第一章	系统概括

#### 1.1	历史

### 1.2	系统结构

外层的程序，诸如shell及编辑程序（ed与vi),是通过引用一组明确定义的系统调用而与内核交互的。

### 1.3	用户看法

#### 1.3.1	文件系统

UNIX文件系统有如下特点：

- 层次结构。
- 对文件数据的一致的处理。
- 建立与删除文件的能力
- 文件的动态增长
- 文件数据的保护
- 把外围设备（如终端及磁带）作为文件对待

#### 1.3.2	处理环境

一个程序是一个可执行文件，而一个进程则是一个执行中的程序的实例

#### 1.3.3	构建原语

 重定向I/O的能力便是这样的为shell用户可见的一个原语。

进程通常可以存取三个文件：他们从标准输入文件上读，往标准输出文件上写，以及把错误消息写到标准错误文件上。

### 1.4	操作系统服务

### 1.5	关于硬件的假设

- 用户态下的进程能存取他们自己的指令与数据，但不能存取内存指令和数据（或者其他进程的指令和数据）。然而，核心态下的进程能够存取内核和用户地址。
- 某些机器指令是特权指令，在用户态下执行特权指令会引起错误。

#### 1.5.1	中断与例外

当收到中断时，内核保存他的上下文（表示进程正在做什么的瞬时冻结映像），判定中断原因，为中断服务。在内核为中断服务之后，内核恢复被中断了的上下文，并且继续进行，就好想什么都没发生过一样。

#### 1.5.2	处理机执行级

在关键活动期间，有时内核必须阻止中断的发生，因为如果这时允许中断，可能会导致数据的误用。

#### 1.5.3	存储管理

内核是永远驻留在主存中的，对于一个程序进行编译时，编译程序生成一个程序中的地址集合，它们表示变量和数据结构的地址，或诸如函数之类的指令的地址。编译程序产生的是虚机器地址，如同没有其他程序在物理机器上同时执行一样。

当程序在机器上运行时，内核为它分配主存空间，但是不要求编译程序生成的虚地址和他们在机器中占据的物理地址完全相同。内核与机器硬件一起协作，建立虚地址到物理地址的转换，把编译程序生成的地址映射成物理的机器地址。该映射依赖于机器硬件的能力。

### 1.6	本章小结

本章描述了UNIX系统的整个结构、运行在用户态和核心态下的进程间的关系，以及内核关于硬件所做的假设。进程在用户态或核心态下执行，这里，进程通过明确定义的系统调用集合来利用系统服务。

## 第二章	内核导言

### 2.1	UNIX操作系统的体系结构

### 2.2	系统概念介绍

#### 2.2.1	文件子系统概貌

一个文件内部表示由一个索引节点给出，索引节点描述了文件数据在磁盘上的布局，并且包含诸如文件所有者、存取许可权及存取时间等其他信息。每个文件都有一个索引节点，但他可以有几个名字，且这几个名字都映射到该索引节点上。每个名字都被成为一个联结。

内核还包含另外两个数据结构，文件表和用户文件描述符。文件表是一个全局内核结构，但用户文件描述符对每个进程分配一个。当一个进程打开或建立一个文件时，内核在每个表中为相应于该文件的索引节点分配一个表项。这样一共有三种结构表---用户文件描述符、文件表、索引节点表，用这三种结构表中的表项来维护文件的状态及用户对他的存取。**文件表保存着文件中的字节偏移量----下一次读或写从哪里开始，并保存着对打开的进程所允许的权限。用户文件描述符标识着一个进程的所有打开文件。**

一个文件系统由一个逻辑块序列组成，每个块都包含512、1024、2048个字节或512字节的任意倍数，这要依赖于系统的实现。

**文件系统布局**

- 引导块占据文件系统的开头，典型地，是一个扇区。它可以含有被读入机器中起引导或初启操作系统作用的引导代码。
- 超级快描述了文件系统的状态---如它有多大，能存储多少文件，在文件系统的何处可找到空闲空间，以及其它信息。
- 索引节点表是一张装有索引节点的表，它在文件系统中跟在超级快后面。当配置一个文件系统时，管理人员应指明索引节点表的大小。内核通过索引来访问索引节点表中的索引节点。
- 数据块在索引节点结束后开始，并且包含文件数据与管理数据。一个已被分配的数据块，能切仅能属于文件系统中的一个文件。

#### 2.2.2	进程

一个进程是一个程序的执行，它是由一系列有格式字节组成的，这些有格式字节被解释成机器指令、数据和栈区。

进程通过系统调用与其他进程进行通信。

UNIX上的进程是被系统调用fork所创建的实体。除了**0进程**外，每个进程都是被另一个进程执行系统调用fork时创建的。

0进程是一个特殊进程，他是在系统引导时被"手工"创建的；当它创建一个子进程（1进程）之后，0进程就变成对换进程。

用户对一个程序的源代码进行编译以建立一个可执行文件，可执行文件由以下几部分组成：


- 描述头文件属性的一组“头标”
- 程序正文
- 数据的机器语言表示，他给出程序开始执行时的初值；一个空间指示，它指出内核应该为被称为bss的未初始化数据分配多大空间(在运行时内核把bss初值置为0)；
- 其他段，诸如符号表信息

1. 进程上下文

   一个进程的上下文包括被进程正文所定义的进程状态、进程的全局用户变量和数据结构的值、它使用的机器寄存器的值、存储在他的进程表项与u区中的值以及它的用户栈和核心栈的内容。操作系统的正文和他的全局数据结构被所有的进程所共享，因而不是进程上下文的一部分。

2. 进程状态

   进程的生命周期能被划分为一组状态。

   - 进程正在用户态下执行
   - 进程正在核心态下执行
   - 进程未正在执行，但它已准备好----一旦调度程序选中了它，它就可以投入运行
   - 进程正在睡眠

3. 状态转换

   内核通过仅当一个进程是自己进入睡眠时才允许上下文切换，以及通过禁止一个进程改变另一个进程的状态来保护它的一致性。它还在代码临界区周围提高处理机执行级，已封锁其他能引起非一致性的中断。进程调度程序定期的抢占用户态下的进程执行，以使进程不能独占式的使用CPU

4. 睡眠与唤醒

   当我们说进程在一个事件上睡眠时，这意味着，直到该事件发生时，他们一直处于睡眠状态；当事件发生时它们被唤醒；，并且进入"就绪"状态。

### 2.3	内核数据结构

大多数内核数据结构都占据固定长度的表而不是动态的分配空间，这一方法的优点是内核代码简单。但它限制了一种数据结构的表项的数目。

### 2.4	系统管理

管理进程可以非严格地归入为用户团体地公共福利提供各种功能的那类进程。这些功能包括：磁盘格式化、新文件系统的创建、修复被破坏的文件系统、内核调试以及其他。

### 2.5	本章小结

本章描述了内核体系结构：它的两个主要成分是文件子系统与进程子系统。文件子系统控制用户文件中数据存储和检索。文件被组织到文件系统中，而文件系统被看作一个逻辑设备

## 第三章	数据缓冲区高速缓冲

对于文件系统的一切存取操作，内核都能通过每次直接从磁盘上读取或者往磁盘上写来实现。 但是慢的磁盘传输速率会使系统响应时间加长、吞吐率降低。因此内核通过保持一个成为数据缓冲区高速缓冲的内部数据缓冲区来试图减小对磁盘地存取频率。高速缓冲区含有最近被使用过的磁盘块的数据。  

### 3.1	缓冲头部

​	在系统除启期间，内核按照存储器的大小及系统性能的约束条件来为若干个缓冲区分配空间。一个缓冲区由两部分组成：一个含有磁盘上的数据的存储器数组及一个用来表示缓冲区的缓冲头部。由于缓冲头部到数据数组之间是一对一映射关系，所以下面的讨论常把两部分通称作缓冲区。

缓冲头部包含一个设备号字段与一个块号字段，这两个字段指明了文件系统与磁盘上的数据地块号，并且唯一的标识了该缓冲区。设备号是逻辑文件系统号，而不是物理设备号。缓冲区头部也包含一个指向该缓冲的数据数组的指针，该数组至少必须有磁盘块那么大。缓冲头部还包含状态字节，他概括了当前的缓冲区状态一个缓冲区状态有如下组合：

- 缓冲区当前为“上锁”（“上锁”与”忙“将互换使用，正如“开锁”和"闲"将互换使用一样）
- 缓冲区包含有效数据
- 内核再把某缓冲区重新分配出去之前必须把该缓冲区内容写到磁盘上这一条叫"延迟写"
- 内核当前正在从磁盘往缓冲区读信息或把缓冲区的内容写到磁盘上；
- 一个进程当前正在等候缓冲区变为闲

### 3.2	缓冲池的结构

  内核按最近最少使用算法把数据缓存于2缓冲池中：在它把一个缓冲区分配给磁盘块之后，只要不是所又琪亚缓冲区都在更近的时间内被使用过，他就不能让另一磁盘块使用该缓冲区。内核维护一个缓冲区的空闲表，他保存最近使用的次序。

当内核把一个缓冲区还给缓冲池时，它通常把该缓冲区附到空闲表的尾部。装有有效数据的缓冲区会越来越近的移动到空闲表的头部。因此，离空闲表头部近的缓冲区比离空闲表头部远的缓冲区是最近最少使用。

 一个缓冲区可以同时既存在于一个散列队列中又存在一个空闲队列中，所以内核有两个方法找到他：吐过他要寻找一个特定的缓冲则它搜索散列队列；如果他要寻找任何一个空闲缓冲区，则它从空闲表中找下一个缓冲区。

### 3.3	缓冲区检索

当要从一个特定的磁盘块上读数据时，内核检查是否该块在缓冲区池中。如果不在，则分配给他一个空闲缓冲区。

当要把数据写到一个特定的磁盘上时，内核检查是否该快在缓冲区池中。如果不在，则为那块分配一个空闲缓冲区。

在算法getblk中内核吧一个缓冲区分配给磁盘块时是可能出现的五种典型情况 ：

1. 内核发现该块在它的散列队列中，并且他的缓冲区是空闲的。---此时，内核将该缓冲区标记上‘忙’，并从缓冲区队列中取走该缓冲区。剩余在缓冲区队列中的其他缓冲区，再依次排序。
2. 内核在散列队列中找不到该块，因此，他从空闲表中分配一个缓冲区。---如果**空闲缓冲区队列**不为空，则摘下空闲缓冲区的第一个缓冲区，并设置BUSY标志。指定新的设备号和磁盘块号，与该设备建立联结关系。
3. 内核在该设备的缓冲区队列中没找到该块，它必须从空闲缓冲区队列中找一个，但是从空闲队列中摘下的缓冲区已被标记上“延迟写”标志时，---应将该缓冲区的内容写到磁盘上。内核在从空闲缓冲区队列中分配另一个缓冲区。当异步写完成时，内核把缓冲区标记为“旧”，把该缓冲区释放，并将其置于空闲缓冲区的队首。**在异步写之前，该缓冲区已经从空闲表尾部出发迁移到了空闲表头部。**
4. 内核在散列队列中找不到该块，并且空闲缓冲区表已空。---此时，请求此I/O操作的进程进入休眠，当释放该缓冲区时再唤醒它。
5. 内核在散列队列中找到该块，但他的缓冲区当前为忙。---则在该缓冲区的flag中再设置WAIT标志，表示有进程正在等待使用它。。然后请求该块的进程进入睡眠状态，待缓冲区使用完毕后被释放时在被唤醒。

###  3.4	读磁盘块与写磁盘块

为了读一个磁盘块，进程使用getblk算法在高速缓冲中搜索这个磁盘块。

- 若果它在高速缓冲中，则内核就可不必物理的从磁盘上读取该块，就能立即将它返回。
- 如果他不在高速缓冲中，则内核调用磁盘驱动程序，以"安排"一个读请求，而后去睡眠，等候IO完成时间的发生。
- 磁盘驱动程序通知磁盘控制硬件，说它想要读取数据。磁盘控制器过一会将数据传送到该缓冲区。
- 最后，当I/O完成时，磁盘控制器中断处理机，由磁盘中断处理程序唤醒正在睡眠的进程。
- 现在，磁盘块的内容已在缓冲区中了。请求这一特定的磁盘块的哪些模块现在拥有该数据；当他们不再需要该缓冲区时，他们释放该缓冲区，以便其他进程能存取它。

**写一个磁盘块**

- 内核通知磁盘驱动程序说她有一个缓冲区的内容应该被输出。
- 磁盘驱动程序调度到该块以便进行I/O
- 如果写是同步的，则调用者进程进入睡眠等候I/O完成，并且当它醒来时释放该缓冲区
- 如果写是异步的，则内核开始磁盘写，但不等待写完成。
- 当I/O完成时，内核将释放该缓冲区。

### 3.5	高速缓冲的优点与缺点

- 缓冲区的使用提供了统一的磁盘存取方法，因为内核不需要知道I/O的原因。不论数据是文件的一部分，还是索引节点，还是超级块的一部分内核都是往缓冲区或从缓冲区拷贝数据。磁盘I/O的缓冲技术使代码更加模块化，因为内核中进行磁盘I/O的那些部分，对所有的目的都使用一个接口。简而言之，系统设计较为简单。
- 系统对进行I/O的用户进程没有做数据对齐限制，因为内核在内部实现了数据对齐。硬件实现常常需要对磁盘I/O的特别的数据对齐。
- 高速缓冲的使用可减少访盘次数，从而提高整个系统的吞吐量，减少响应时间
- 缓冲区算法有助于确保文件系统的完整性，因为他们维护一个公共的、包含在高速缓冲中的磁盘块的单一映像。
- 访盘次数的减少对于良好的吞吐量与响应时间来说很重要 但高速缓冲策略也引进了一些缺点。--发出一个写系统调用的用户从来不能确定这些数据到底什么时候真正的写到磁盘上 了。
- 高速缓冲的使用，使得当往用户进程读或从用户进程写时需要一次额外的数据拷贝过程。

### 3.6	本章小结 

## 4	文件的内部表示

UNIX系统中每个文件都有一个唯一的索引节点。索引节点包含着为进程存取文件所必需的信息，如文件所有者、存取权限、文件长度、文件数据在文件系统中的位置每个路径名都唯一的指明一个文件，内核把路径名转换成文件索引点。

算法iget返回一个先前标识了的索引节点，他可能经由高速缓冲而从磁盘上读出的。算法iput释放索引节点。算法bmap为存取一个文件设置内核参数 ，算法namei使用算法iget、iput以及bmap把一个用户级路径转换成一个索引节点。算法alloc和free为文件分配及释放磁盘块，而算法ialloc与ifree为文件分配及释放索引节点。

### 4.1	索引节点	

#### 4.1.1	定义

索引节点以静态形式存在于磁盘上，内核把他们读进内存索引节点表中以便操纵它们。磁盘索引节点有以下字段构成：

- 文件所有者标识号
- 文件类型
- 文件存取许可权---文件所有者，文件用户组所有者及其他用户。每类都具有读、写、执行该文件的存取权，
- 文件存取时间
- 文件联结数目
- 文件数据的磁盘地址明细表
- 文件大小

**索引节点并不标明存取该文件的路径名**

####  4.1.2	对索引节点的存取

内核用文件系统和索引节点来标识特定的索引节点，并在高层算法请求时分配内存索引节点。

块号=((索引节点号-1)/每块的索引节点数目) + 索引节点表的起始块号

字节偏移量：

((索引节点号-1)	 mod	（每块的索引节点数目)）  *  	磁盘索引节点大小  

#### 4.1.3	释放索引节点



### 4.2	正规文件的结构

### 4.3	目录

### 4.4	路径名到索引节点的切换  

因为内核在内部使用索引节点工作而不是用路径名工作，所以内核把路径名装换成索引节点号，以存取文件。算法namei没次分析路径名的一个分量，根据这个名字及正在搜索的目录，把每个分量转换成一索引节点，并且最终返回输入路径名下的索引节点 

### 4.5	超级块

超级块由如下字段构成：

- 文件系统的规模
- 文件系统中空闲块的数目
- 文件系统上可用的空闲块表
- 空闲块表中下一空闲快的下标
- 索引节点表的大小
- 文件系统中空闲索引节点的数目
- 文件系统中的空闲索引节点表
- 空闲索引节点表中下一个空闲索引节点的下标
- 空闲块表的锁字段和空闲索引节点表的锁字段
- 用来指示出超级块已经被修改的标志

### 4.6	为新文件分配索引节点

### 4.7	磁盘块的分配

### 4.8	其他文件类型

### 4.9	本章小结

## 第五章	文件系统的调用

### 5.1	系统调用open

